apiVersion: batch/v1
kind: Job
metadata:
  name: es-service-user-setup
spec:
  template:
    spec:
      containers:
      - name: setup
        env:
        - name: ELASTIC_PASSWORD
          valueFrom:
            secretKeyRef:
              name: greenearth-es-local-es-elastic-user
              key: elastic
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Waiting for Elasticsearch to be ready..."

          # Wait for Elasticsearch to be available
          until curl -k -s -u "elastic:$ELASTIC_PASSWORD" -o /dev/null -w "%{http_code}" https://greenearth-es-local-es-http:9200/ | grep -q "200"; do
            echo "Waiting for Elasticsearch..."
            sleep 10
          done

          echo "Elasticsearch is ready! Creating es-service-user role and user..."

          # Create the es_service_role with specific privileges
          curl -k -X POST "https://greenearth-es-local-es-http:9200/_security/role/es_service_role" \
            -u "elastic:$ELASTIC_PASSWORD" \
            -H "Content-Type: application/json" \
            -d '{
              "cluster": ["manage_index_templates", "monitor"],
              "indices": [
                {
                  "names": ["posts*", "post_tombstones*", "likes*"],
                  "privileges": ["create_index", "manage", "write", "read"]
                }
              ]
            }'

          echo ""
          echo "Role created successfully!"

          # Create the service user with the role
          curl -k -X POST "https://greenearth-es-local-es-http:9200/_security/user/$ES_SERVICE_USERNAME" \
            -u "elastic:$ELASTIC_PASSWORD" \
            -H "Content-Type: application/json" \
            -d "{
              \"password\": \"$ES_SERVICE_PASSWORD\",
              \"roles\": [\"es_service_role\"],
              \"full_name\": \"Elasticsearch Service User\",
              \"email\": \"es-service@greenearth.local\"
            }"

          echo ""
          echo "User created successfully!"
          echo "es-service-user setup completed!"
