apiVersion: v1
kind: ConfigMap
metadata:
  name: posts-index-template
data:
  posts-index-template.json: |
    {
      "index_patterns": ["posts_v1*"],
      "template": {
        "settings": {
          "number_of_shards": $(INDEX_SHARDS),
          "number_of_replicas": $(INDEX_REPLICAS),
          "refresh_interval": "30s",
          "translog.durability": "async",
          "translog.sync_interval": "30s",
          "analysis": {
            "analyzer": {
              "content_analyzer": {
                "type": "standard",
                "stopwords": "_english_"
              }
            }
          }
        },
        "mappings": {
          "_routing": {
            "required": true
          },
          "properties": {
            "at_uri": {
              "type": "keyword",
              "index": true
            },
            "author_did": {
              "type": "keyword",
              "index": true
            },
            "content": {
              "type": "text",
              "index": true,
              "analyzer": "content_analyzer",
              "fields": {
                "raw": {
                  "type": "keyword",
                  "ignore_above": 10922
                }
              }
            },
            "created_at": {
              "type": "date",
              "format": "iso8601"
            },
            "thread_root_post": {
              "type": "keyword",
              "index": true
            },
            "thread_parent_post": {
              "type": "keyword",
              "index": true
            },
            "quote_post": {
              "type": "keyword",
              "index": true
            },
            "embeddings": {
              "type": "object",
              "properties": {
                "all_MiniLM_L12_v2": {
                  "type": "dense_vector",
                  "dims": 384,
                  "index": true,
                  "similarity": "cosine"
                },
                "all_MiniLM_L6_v2": {
                  "type": "dense_vector",
                  "dims": 384,
                  "index": true,
                  "similarity": "cosine"
                }
              }
            },
            "indexed_at": {
              "type": "date",
              "format": "iso8601"
            },
            "like_count": {
              "type": "integer",
              "index": true
            },
            "media": {
              "type": "nested",
              "properties": {
                "id": {"type": "keyword", "index": true},
                "media_type": {"type": "keyword", "index": true},
                "mime_type": {"type": "keyword", "index": true},
                "size": {"type": "long", "index": true},
                "aspect_ratio": {"type": "float", "index": true},
                "width": {"type": "integer", "index": true},
                "height": {"type": "integer", "index": true}
              }
            },
            "contains_images": {"type": "boolean", "index": true},
            "contains_video": {"type": "boolean", "index": true},
            "image_count": {"type": "integer", "index": true},
            "video_count": {"type": "integer", "index": true},
            "media_count": {"type": "integer", "index": true}
          }
        }
      }
    }
