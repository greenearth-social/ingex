apiVersion: batch/v1
kind: Job
metadata:
  name: es-service-user-setup
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: setup
        image: curlimages/curl:8.4.0
        env:
        - name: ELASTIC_PASSWORD
          valueFrom:
            secretKeyRef:
              name: greenearth-es-elastic-user
              key: elastic
        - name: ES_SERVICE_USERNAME
          valueFrom:
            secretKeyRef:
              name: es-service-user-secret
              key: username
        - name: ES_SERVICE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: es-service-user-secret
              key: password
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Waiting for Elasticsearch to be ready..."

          # Wait for Elasticsearch to be available
          until curl -k -s -u "elastic:$ELASTIC_PASSWORD" -o /dev/null -w "%{http_code}" https://greenearth-es-http:9200/ | grep -q "200"; do
            echo "Waiting for Elasticsearch..."
            sleep 10
          done

          echo "Elasticsearch is ready! Creating/updating es-service-user role and user..."

          # Create / update the es_service_role with specific privileges
          curl -k -X POST "https://greenearth-es-http:9200/_security/role/es_service_role" \
            -u "elastic:$ELASTIC_PASSWORD" \
            -H "Content-Type: application/json" \
            -d '{
              "cluster": ["manage_index_templates", "monitor"],
              "indices": [
                {
                  "names": ["posts*", "post_tombstones*", "likes*", "like_tombstones*", "hashtags*"],
                  "privileges": ["create_index", "manage", "write", "read"]
                }
              ]
            }'

          echo ""
          echo "Role created/updated successfully!"

          # Create / update the service user with the role
          curl -k -X POST "https://greenearth-es-http:9200/_security/user/$ES_SERVICE_USERNAME" \
            -u "elastic:$ELASTIC_PASSWORD" \
            -H "Content-Type: application/json" \
            -d "{
              \"password\": \"$ES_SERVICE_PASSWORD\",
              \"roles\": [\"es_service_role\"],
              \"full_name\": \"Elasticsearch Service User\",
              \"email\": \"es-service@greenearth.local\"
            }"

          echo ""
          echo "User created/updated successfully!"
          echo "es-service-user setup completed!"
      serviceAccountName: es-service-user-setup-sa
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: es-service-user-setup-sa
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: es-service-user-setup-role
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create", "get", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: es-service-user-setup-binding
subjects:
- kind: ServiceAccount
  name: es-service-user-setup-sa
roleRef:
  kind: Role
  name: es-service-user-setup-role
  apiGroup: rbac.authorization.k8s.io
